<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="icon"
			href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“±</text></svg>"
		/>
		<title>Mobile Preview Helper</title>
		<script>
			function qsa(selector, context = null) {
				return Array.from(
					(context ?? document)?.querySelectorAll(selector) || [],
				);
			}
		</script>
		<link rel="stylesheet" href="./reboot.css" />
		<style>
			body {
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				background: var(--bs-gray-400);
			}

			h1 {
				font-size: 0.8rem;
				position: fixed;
				left: 1rem;
				top: 50%;
				transform: rotate(-90deg) translateX(-50%);
				transform-origin: 0 0;
				margin: 0;
				color: var(--bs-gray);
				white-space: nowrap;
				opacity: 0.75;
			}

			h1 a {
				color: inherit;
			}
			h1 a:hover {
				color: var(--bs-black);
			}

			#preview {
				flex: 1;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				min-height: 400px;
			}

			#size-label {
				text-align: center;
				padding-top: 1.5rem;
				font-size: 0.9em;
				font-family: var(--bs-font-monospace);
				color: var(--bs-gray);
			}
			iframe {
				border: none;
				border-radius: 24px;
				background: white;
				display: block;
				outline: 12px solid black;
				box-shadow: 0 5px 15px 10px rgba(0 0 0 / 0.8);
				transition: all 0.25s ease-in-out;
			}

			#controls {
				padding: 1rem;
				display: flex;
				gap: 1rem;
			}

			.btn {
				border-radius: 0.25rem;
				border: 0;
				font-size: 0.9rem;
			}

			.btn:hover,
			.btn.active {
				background-color: var(--bs-black);
				color: var(--bs-white);
			}

			.x {
				position: fixed;
				right: 0;
				top: 0;
				padding: 12px 16px;
				line-height: 1;
				text-decoration: none;
				font-size: 1.5rem;
				color: var(--bs-gray);
				background-color: transparent;
				border: 0;
			}
			.x:hover {
				color: var(--bs-black);
			}
			.help {
				position: fixed;
				left: 0;
				top: 0;
				padding: 12px 16px;
				line-height: 1;
				text-decoration: none;
				font-size: 1.2rem;
				color: var(--bs-gray);
			}
			.help:hover {
				color: var(--bs-black);
			}

			#history-controls {
				display: flex;
				gap: 0.25rem;
				padding: 1rem;
			}
			#history {
				font-size: 0.8rem;
				padding: 0.25rem 0.5rem;
				border-radius: 0.25rem;
				border: 1px solid var(--bs-gray);
				min-width: 200px;
			}
			#clear-history {
				padding: 0.25rem 0.5rem;
				font-size: 0.7rem;
				line-height: 1;
			}
			#resolution {
				font-size: 0.8rem;
				padding: 0.25rem 0.5rem;
				border-radius: 0.25rem;
				border: 1px solid var(--bs-gray);
			}
		</style>
	</head>
	<body>
		<h1>
			Mobile Preview by
			<a href="https://github.com/marianmeres" target="_blank"
				>@marianmeres</a
			>
		</h1>

		<a
			class="help"
			href="https://github.com/marianmeres/mobile-preview"
			title="Help"
			target="_blank"
			>?</a
		>
		<button
			class="x"
			onclick="location.href = urlInput.value"
			title="Go to URL"
		>
			âœ•
		</button>

		<div id="history-controls">
			<select id="history">
				<option value="">â€” History â€”</option>
			</select>
			<button class="btn" id="clear-history" title="Remove selected">
				âœ•
			</button>
		</div>

		<div id="preview">
			<iframe width="390" height="844"></iframe>
			<div id="size-label"></div>
		</div>

		<div id="controls">
			<select id="resolution">
				<option value="375x667">iPhone SE</option>
				<option value="360x800">Android</option>
				<option value="390x844">iPhone 14</option>
				<option value="412x915">Galaxy S</option>
				<option value="430x932">Pro Max</option>
			</select>
			<button
				class="btn"
				onclick="reloadCurrentIframeUrl()"
				title="Reload"
			>
				â†»
			</button>
			<button class="btn" onclick="promptUrl()" title="Set url">â†’</button>
		</div>

		<input type="hidden" name="iframe-url" value="./placeholder.html" />
		<input type="hidden" name="size" value="360x800" />

		<script>
			const HISTORY_KEY = "mobile-preview-history";
			const SIZE_KEY = "mobile-preview-size";
			const LAST_URL_KEY = "mobile-preview-last-url";
			const MAX_HISTORY = 10;

			// poor man's reactive state source
			const urlInput = qsa("input[name=iframe-url]")[0];
			const sizeInput = qsa("input[name=size]")[0];

			//
			const resolutionSelect = qsa("#resolution")[0];
			const iframe = qsa("iframe")[0];
			const sizeLabel = qsa("#size-label")[0];
			const historySelect = qsa("#history")[0];
			const clearHistoryBtn = qsa("#clear-history")[0];

			//
			sizeInput.addEventListener("change", render);
			urlInput.addEventListener("change", loadUrl);
			historySelect.addEventListener("change", () =>
				setUrl(historySelect.value),
			);
			clearHistoryBtn.addEventListener("click", removeSelectedHistory);
			resolutionSelect.addEventListener("change", () => {
				sizeInput.value = resolutionSelect.value;
				sizeInput.dispatchEvent(new Event("change"));
			});

			// restore saved size
			const savedSize = localStorage.getItem(SIZE_KEY);
			if (savedSize) sizeInput.value = savedSize;

			// restore last used URL
			const lastUrl = localStorage.getItem(LAST_URL_KEY);
			if (lastUrl) {
				urlInput.value = lastUrl;
			}

			// kick off
			render();
			loadUrl();
			renderHistory();
			historySelect.value = urlInput.value;

			//

			function render() {
				const [width, height] = sizeInput.value.split("x");
				iframe.width = width;
				iframe.height = height;
				sizeLabel.textContent = `${width} Ã— ${height}`;
				localStorage.setItem(SIZE_KEY, sizeInput.value);
				resolutionSelect.value = sizeInput.value;
			}

			function loadUrl() {
				iframe.src = urlInput.value.trim();
			}

			function setUrl(value) {
				if (value) {
					urlInput.value = value;
					localStorage.setItem(LAST_URL_KEY, value);
					urlInput.dispatchEvent(new Event("change"));
				}
			}

			function promptUrl() {
				const url = prompt("Go to URL", "http://");
				if (url && url !== "http://") {
					saveToHistory(url);
					setUrl(url);
				}
			}

			function getHistory() {
				try {
					return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
				} catch {
					return [];
				}
			}

			function saveToHistory(url) {
				let history = getHistory().filter((u) => u !== url);
				history.unshift(url);
				history = history.slice(0, MAX_HISTORY);
				localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
				renderHistory();
			}

			function removeSelectedHistory() {
				const selected = historySelect.value;
				if (!selected) return;
				const history = getHistory().filter((u) => u !== selected);
				localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
				if (localStorage.getItem(LAST_URL_KEY) === selected) {
					localStorage.removeItem(LAST_URL_KEY);
				}
				renderHistory();
			}

			function renderHistory() {
				const history = getHistory();
				historySelect.innerHTML =
					'<option value="">â€” History â€”</option>';
				history.forEach((url) => {
					const opt = document.createElement("option");
					opt.value = url;
					opt.textContent =
						url.length > 40 ? url.slice(0, 40) + "â€¦" : url;
					historySelect.appendChild(opt);
				});
			}

			function reloadCurrentIframeUrl() {
				try {
					// throws if cross-origin
					iframe.contentWindow.location.reload();
				} catch (e) {
					// so we can only reload the initial src
					loadUrl();
				}
			}
		</script>
	</body>
</html>
